# 剧本分镜智能体

剧本分镜智能体工具（Script-to-Shot AI Agent）

## 核心目标

- 将任意长度剧本 → 拆分为 5秒/段 的短视频脚本单元（Shot）
- 每段包含：画面描述 + 角色动作 + 对话（如有）+ 镜头语言
- 保证跨片段连续性（角色外观、位置、情绪、动作状态一致）
- 输出格式兼容主流 AI 视频生成平台（文本提示词格式）



## 使用方式

该工具的作用为，可以嵌入到其他项目中。

对外只暴露一个统一接口（函数或 API），支持纯中文文本剧本，或者JSON。每次调用独立，不依赖外部会话。

### 对外接口定义

```python
from typing import Optional, Dict, Any

def generate_storyboard(
    script_text: str,
    style: str = "realistic",
    duration_per_shot: int = 5,
    prev_continuity_state: Optional[Dict[str, Any]] = None
) -> Dict[str, Any]:
    """
    剧本分镜生成主接口（可嵌入 LangGraph 或 A2A 调用）
    
    Args:
        script_text: 用户输入的中文剧本（自然语言）
        style: 视频风格（realistic / anime / cinematic）
        duration_per_shot: 每段目标时长（秒）
        prev_continuity_state: 上一段的 continuity_anchor（用于长剧本续生成）
    
    Returns:
        {
            "shots": [  # 分镜列表
                {
                    "shot_id": 1,
                    "chinese_description": "李明坐在咖啡馆...",
                    "ai_prompt": "A man in a cafe...",
                    "continuity_anchor": { ... }
                },
                ...
            ],
            "final_continuity_state": { ... },  # 供下一段使用
            "total_duration": 20
        }
    """
    # 内部调用多智能体协作流程
    return _run_multi_agent_pipeline(
        script_text,
        style,
        duration_per_shot,
        prev_continuity_state
    )
```

有以下两种使用方式：

### 集成方式 1：

作为 LangGraph 智能体节点

```python
from langgraph.graph import StateGraph, END

# 定义全局状态
class StoryboardState(TypedDict):
    raw_script: str
    style: str
    storyboard: list
    continuity_state: dict
    error: Optional[str]

# 分镜生成节点
def storyboard_agent_node(state: StoryboardState) -> dict:
    try:
        result = generate_storyboard(
            script_text=state["raw_script"],
            style=state["style"],
            prev_continuity_state=state.get("continuity_state")
        )
        return {
            "storyboard": result["shots"],
            "continuity_state": result["final_continuity_state"]
        }
    except Exception as e:
        return {"error": str(e)}

# 构建图
workflow = StateGraph(StoryboardState)
workflow.add_node("generate_storyboard", storyboard_agent_node)
workflow.set_entry_point("generate_storyboard")
workflow.add_edge("generate_storyboard", END)

app = workflow.compile()
```



### 集成方式 2：

通过 A2A 协议调用（HTTP / gRPC）

```java
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI(title="Storyboard Agent Service")

class StoryboardRequest(BaseModel):
    script_text: str
    style: str = "realistic"
    duration_per_shot: int = 5
    prev_continuity_state: dict = None

class StoryboardResponse(BaseModel):
    shots: list
    final_continuity_state: dict
    total_duration: float

@app.post("/a2a/generate_storyboard", response_model=StoryboardResponse)
async def a2a_storyboard(request: StoryboardRequest):
    result = generate_storyboard(
        script_text=request.script_text,
        style=request.style,
        duration_per_shot=request.duration_per_shot,
        prev_continuity_state=request.prev_continuity_state
    )
    return result
```




​	

## 智能体架构

**智能体框架**:LangGraph（专为多智能体状态机设计）

| 智能体名称                                       | 职责                                                         | 技术栈                           | 输入 → 输出                        |
| ------------------------------------------------ | ------------------------------------------------------------ | -------------------------------- | ---------------------------------- |
| 1. 剧本解析智能体（Script Parser Agent）         | 解析原始剧本，提取结构化元素（场景、角色、动作、对话、情绪） | LlamaIndex + 规则引擎            | 原始文本 → 结构化剧本对象（JSON）  |
| 2. 时序规划智能体（Temporal Planner Agent）      | 将剧本按 5 秒粒度切分，估算每段动作/对话时长，避免超时       | 规则库 + LLM（微调动作时长模型） | 结构化剧本 → 带时间戳的分段计划    |
| 3. 连续性守护智能体（Continuity Guardian Agent） | 跟踪角色状态（位置、姿势、情绪、道具），生成/验证连续性锚点  | 向量记忆 + 状态机                | 上一段状态 + 当前动作 → 连续性约束 |
| 4. 分镜生成智能体（Shot Generator Agent）        | 生成符合 AI 视频模型要求的提示词（含镜头、光线、构图）       | LangChain + LLM（GPT-4o/Claude） | 分段内容 + 连续性锚点 → AI Prompt  |
| 5. 质量审查智能体（QA Agent）                    | 检查分镜是否连贯、是否超时、角色是否漂移                     | 规则检查 + LLM 自反思            | 分镜序列 → 修正建议或通过          |

**智能体协作流程图**：

```
graph TD
    A[用户输入剧本] --> B(剧本解析智能体)
    B -->|结构化剧本| C(时序规划智能体)
    C -->|分段计划| D{循环每一段}
    D --> E(连续性守护智能体)
    E -->|连续性锚点| F(分镜生成智能体)
    F -->|AI Prompt + 新状态| G(质量审查智能体)
    G -->|通过?| H{下一段}
    G -->|失败| I[修正并重试]
    H -->|是| D
    H -->|否| J[输出完整分镜序列]
```

**智能体消息格式**（标准化）

```json
{
  "agent": "continuity_guardian",
  "segment_id": 3,
  "input": { ... },
  "output": {
    "continuity_constraints": {
      "character": "李明",
      "must_start_with": "手机刚接住，手微抖",
      "camera_angle": "same as previous shot"
    }
  },
  "status": "success"
}
```

**错误处理与重试**

- QA Agent 发现不连贯 → 触发 **局部重生成**（仅重跑 Shot 3）
- 最大重试次数 = 2，否则告警人工介入



**智能体职责详解**

1. **Script Parser Agent（剧本解析智能体）**

- **职责**：将整段中文剧本 → 结构化动作序列

- **输入**：`"李明坐在咖啡馆..."`（字符串）

- **输出**：

  ```python
  {
    "scenes": [{
      "location": "城市咖啡馆",
      "time": "下午3点",
      "actions": [
        {"character": "李明", "action": "坐在靠窗位置", "emotion": "平静"},
        {"character": "李明", "dialogue": "你...你怎么在这？", "emotion": "紧张"}
      ]
    }]
  }
  ```

- 技术：

  - LlamaIndex + 规则增强的 LLM（GPT-4o）
  - 中文分词（jieba）+ 正则匹配

- 关键能力：

  - 自动识别场景、角色、动作、对话、情绪
  - 推断角色外观（若未提供）

2. **Temporal Planner Agent（时序规划智能体）**

- **职责**：将动作序列切分为 5 秒片段
- **输入**：结构化动作列表
- **输出**：分段计划（每段含动作子集 + 估算时长）
- 技术：
  - **动作时长估算器**（基于动词库 + 对话字数模型）
  - 贪心算法：累计时长 ≤ 5.5 秒（留 0.5 秒缓冲）
- 关键规则：
  - 对话不拆分（一句完整台词）
  - 连续动作尽量同段（如“起身→走向门口”）

3. **Continuity Guardian Agent（连续性守护智能体）**

- **职责**：确保角色状态跨片段连贯

- 输入：

  - 上一段 `continuity_anchor`
  - 当前动作描述

- **输出**：本段初始状态约束 + 新 `continuity_anchor`

- **状态字段**：

  ```python
  {
    "character_name": "李明",
    "pose": "sitting",
    "position": "靠窗桌子",
    "gaze_direction": "downward",
    "holding": "smartphone",
    "emotion": "calm"
  }
  ```

- 关键技术：

  - 状态机（State Machine）跟踪角色
  - 向量相似度比对（防外观漂移）
    - 每段生成后，`continuity_anchor` 存入黑板（Blackboard）
    - 下一段从黑板读取 `initial_state`

4. **Shot Generator Agent（分镜生成智能体）**

- **职责**：生成最终分镜（含 AI Prompt）

- 输入：

  - 分段动作
  - 连续性约束
  - 视频风格（realistic/anime）

- **输出**：

  ```python
  {
    "chinese_description": "李明猛然抬头...",
    "ai_video_prompt": "A man suddenly looks up in shock...",
    "camera": {"shot_type": "medium close-up", ...},
    "continuity_anchor": { ... }
  }
  ```

- 技术：

  - LangChain + GPT-4o（结构化输出）
  - 提示词模板（含镜头语言知识库）

5. **QA Agent（质量审查智能体）**

- **职责**：验证分镜质量
- 检查项：
  - 角色外观是否漂移（对比 appearance）
  - 动作是否超时（>5.5 秒）
  - 连续性是否断裂（位置突变）
  - AI Prompt 是否含禁用词
- 输出：
  - `pass: true` → 进入下一段
  - `pass: false` → 触发局部重试（最多 2 次）





## 处理流程



详细处理流程（端到端）

### Step 1：接收输入

- 输入：纯中文自然语言剧本（`script_text: str`）

- 可选参数：`style`, `duration_per_shot`, `prev_continuity_state`

  ```python
  场景：城市咖啡馆，下午3点，阳光很好。
  李明坐在靠窗的位置，低头看手机。突然，他抬头看见前女友小雨走进来，愣住了，手机差点掉到地上。
  小雨也看见了他，犹豫了一下，还是走了过来。
  小雨（轻声）：好久不见。
  李明（紧张）：你……你怎么在这？
  ```

  

### Step 2：剧本解析（Script Parser Agent）

- 使用 LlamaIndex + 规则引擎解析文本

- 输出结构化剧本对象：

  ```python
  {
    "scenes": [
      {
        "location": "城市咖啡馆内",
        "time": "下午3点",
        "atmosphere": "阳光透过窗户",
        "actions": [
          {"character": "李明", "action": "坐在靠窗位置", "emotion": "平静"},
          {"character": "李明", "action": "抬头看见小雨", "emotion": "震惊"},
          {"character": "小雨", "dialogue": "好久不见。", "emotion": "轻声"}
        ]
      }
    ]
  }
  ```

### Step 3：时序规划（Temporal Planner Agent）

- 将动作序列按 **5 秒粒度**切分

- 估算每段动作时长（基于动作动词库）

- 输出分段计划：

  ```python
  segments = [
    {"id": 1, "actions": [action1], "est_duration": 4.8},
    {"id": 2, "actions": [action2, action3], "est_duration": 5.1},
    ...
  ]
  ```

### Step 4：逐段生成分镜（循环）

对每个 `segment` 执行：

#### 4.1 连续性守护（Continuity Guardian Agent）

- 输入：`prev_continuity_state`（来自上一段或用户）
- 输出：本段起始状态约束（`initial_constraints`）

#### 4.2 分镜生成（Shot Generator Agent）

- 调用 LLM（如 GPT-4o）生成：
  - 中文画面描述（供人读）
  - 英文 AI 视频提示词（供模型用）
  - 镜头语言、角色状态
- 输出单段分镜对象

#### 4.3 状态更新

- 提取本段结束状态 → 作为下一段的 `prev_continuity_state`

### Step 5：质量审查（QA Agent）

- 检查：
  - 角色是否漂移（appearance 不一致）
  - 动作是否超时（>5.5 秒）
  - 连续性是否断裂（位置突变）
- 若失败 → 局部重试（最多 2 次）

### Step 6：格式化输出

- 聚合所有分镜
- 返回标准化 JSON

```json
{
  "job_id": "shotgen_20251022_cafe_reunion",
  "input_script": "场景：城市咖啡馆，下午3点，阳光很好。\n李明坐在靠窗的位置，低头看手机。突然，他抬头看见前女友小雨走进来，愣住了，手机差点掉到地上。",
  "style": "realistic",
  "duration_per_shot": 5,
  "total_shots": 2,
  "total_duration_sec": 10,
  "shots": [
    {
      "shot_id": 1,
      "time_range_sec": [0, 5],
      "scene_context": {
        "location": "城市咖啡馆内",
        "time_of_day": "下午3点",
        "atmosphere": "阳光透过落地窗，背景有轻柔爵士乐"
      },
      "characters_in_frame": ["李明"],
      "initial_state": [
        {
          "character_name": "李明",
          "pose": "坐姿，身体微前倾",
          "position": "靠窗第二张桌子",
          "holding": "智能手机",
          "emotion": "平静",
          "appearance": "28岁，黑发，戴黑框眼镜，穿灰色毛衣"
        }
      ],
      "action_description": "李明专注地看着手机屏幕，手指偶尔滑动。",
      "dialogue": "",
      "camera": {
        "shot_type": "medium shot",
        "angle": "eye-level",
        "movement": "static"
      },
      "ai_video_prompt": "A young man with black-rimmed glasses sits alone at a sunlit cafe table, scrolling on his smartphone. Medium shot, natural afternoon light, realistic cinematic style, shallow depth of field, cozy atmosphere.",
      "continuity_anchor": [
        {
          "character_name": "李明",
          "pose": "sitting, looking down at phone",
          "phone_position": "held in both hands, 30cm above wooden table",
          "gaze_direction": "downward",
          "emotion": "calm"
        }
      ]
    },
    {
      "shot_id": 2,
      "time_range_sec": [5, 10],
      "scene_context": {
        "location": "城市咖啡馆内",
        "time_of_day": "下午3点",
        "atmosphere": "阳光透过落地窗，背景有轻柔爵士乐"
      },
      "characters_in_frame": ["李明"],
      "initial_state": [
        {
          "character_name": "李明",
          "pose": "sitting, looking down at phone",
          "position": "靠窗第二张桌子",
          "holding": "智能手机",
          "emotion": "calm",
          "appearance": "28岁，黑发，戴黑框眼镜，穿灰色毛衣"
        }
      ],
      "action_description": "李明猛然抬头看向咖啡馆门口，双眼睁大，手机从左手滑落，距离桌面约10厘米。",
      "dialogue": "",
      "camera": {
        "shot_type": "medium close-up",
        "angle": "slightly low angle",
        "movement": "quick focus pull from phone to eyes"
      },
      "ai_video_prompt": "The same man suddenly looks up in shock toward the cafe entrance, his phone slipping from his left hand halfway to the table. Medium close-up, natural lighting, realistic style, subtle camera shake, focus transition from hand to face.",
      "continuity_anchor": [
        {
          "character_name": "李明",
          "pose": "sitting, upper body recoiling slightly backward",
          "phone_position": "falling, 10cm above table",
          "gaze_direction": "toward cafe entrance",
          "emotion": "shock"
        }
      ]
    }
  ],
  "final_continuity_state": [
    {
      "character_name": "李明",
      "pose": "sitting, upper body recoiling slightly backward",
      "phone_position": "falling, 10cm above table",
      "gaze_direction": "toward cafe entrance",
      "emotion": "shock"
    }
  ],
  "metadata": {
    "generated_at": "2025-10-22T14:35:00Z",
    "llm_model": "gpt-4o",
    "continuity_verified": true,
    "version": "1.0"
  }
}
```



## 关键技术设计

### 1. **连续性管理（核心！）**

- **状态传递**：`continuity_anchor` → `initial_state`
- **角色注册表**：首次出现时生成 appearance，后续强制复用
- **漂移检测**：计算 appearance 向量相似度（<0.8 则告警）

### 2. **动作时长估算**

- **动词库**：`走: 2.0s`, `起身: 1.5s`
- **对话模型**：`时长 = max(字数×0.35×情绪因子, 1.5)`
- **角色因子**：`elder: ×1.3`, `child: ×0.85`

### 3. **AI Prompt 生成**

- **英文强制**：因主流视频模型依赖英文

- **结构化模板**：

  ```python
  [主体], [动作], [镜头], [光线], [风格]
  Example: "A man in cafe, looking up in shock, medium close-up, natural lighting, realistic style"
  ```

### 4. **错误恢复机制**

- **局部重试**：仅重生成失败分镜（非全文重跑）
- **降级策略**：QA 失败 2 次后，简化动作描述



## 分镜输出示例

（基于上文剧本）每段都继承上一段的空间位置+角色状态，避免“换脸”或“瞬移” 
	📽️ Shot 1（0–5秒）
		AI Prompt:
		"A young man (Li Ming) sits alone at a window table in a cozy cafe, afternoon sunlight streaming in. He stares intently at his smartphone. Medium shot, calm atmosphere, realistic style."
	📽️ Shot 2（5–10秒）
		AI Prompt:
		"Li Ming suddenly looks up toward the cafe entrance, eyes wide in shock. His phone begins to slip from his left hand, halfway to the table. Medium close-up, shallow depth of field, natural lighting. Background slightly blurred."
	📽️ Shot 3（10–15秒）
		AI Prompt:
		"A woman (Xiao Yu) enters the cafe, sees Li Ming, and pauses. She hesitates, then walks slowly toward his table. Over-the-shoulder shot from Li Ming's perspective, soft focus on her face showing uncertainty."
	📽️ Shot 4（15–20秒）
		AI Prompt:
		"Xiao Yu stands beside Li Ming's table. She says softly: 'Long time no see.' Li Ming looks up nervously, hands gripping the edge of the table. Two-shot, eye-level, warm cafe lighting."
		

## 技术实现建议

| 模块         | 技术方案                                                     |
| ------------ | ------------------------------------------------------------ |
| 工作流编排   | 通过langchain + langgraph 分镜生成工作流编排，负责整体流程控制，调用 LlamaIndex、LLM、规则引擎等组件 |
| 剧本解析     | LlamaIndex + 自定义剧本语法解析器，负责深度理解原始剧本，并构建可查询的结构化知识库，实现数据检索与索引优化 |
| 动作时长估算 | 基于动作动词库（如“走”≈2秒，“说一句话”≈3秒）                 |
| 连续性锚点   | 向量记忆（Vector Memory）存储角色状态                        |
| Prompt 生成  | LLM（如 GPT-4o / Claude 3.5 / qwen3） + 提示模板引擎         |
| 输出格式     | JSON                                                         |

> 注意事项：
> 	1、仅用 LlamaIndex 做检索，LangChain 不构建独立向量库
> 	2、连续性锚点统一由 LangChain 管理
> 	3、LlamaIndex 仅用于检索，生成任务交给 LangChain 的 LLM Chain



## 进阶功能（可选）

​	🔄 角色一致性ID：为每个角色生成固定外观描述（如“李明：黑发，戴黑框眼镜，穿灰色毛衣”），嵌入每段prompt
​	🎞️ 镜头语言建议：自动推荐镜头类型（特写/全景/跟拍）以增强叙事
​	⚠️ 不连贯预警：检测潜在跳切（如角色位置突变），提示用户调整
​	🖼️ 参考图绑定：支持上传角色/场景参考图，生成带--image参数的提示词		
​		